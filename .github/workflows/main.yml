name: fetch-gists
on:
  workflow_dispatch:
  schedule:
    # toutes les 3 heures
    - cron: '0 */3 * * *'

jobs:
  fetch-gists:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          github-token: ${{ secrets.BLOG_TOKEN }}
      - name: Fetch Gists
        id: fetch-gists
        uses: actions/github-script@0.3.0
        with:
          github-token: ${{ secrets.BLOG_TOKEN }}
          script: |
            const fs = require("fs");
            let newArticles = 0;
            const gists = await github.gists.list();
            if (!gists.data) {
              console.log("No gists found");
              return;
            }
            gists.data.forEach(async (gist) => {
              const files = Object.keys(gist.files);
              files.forEach(async (file) => {
                if (file.endsWith('.md')) {
                  const fileContent = await github.gists.get({ gist_id: gist.id });
                  let mdContent = fileContent.data.files[file].content;
                  // remove leading "# " from title
                  if (mdContent.startsWith("# ")) {
                    mdContent = mdContent.substring(2);
                  }
                  let title = gist.description;
                  if(title.length > 30) {
                    title = title.slice(0, 30) + "...";
                  }
                  const header = "title="+ title +"\ndate="+gist.created_at+"\ntype=post\ntags=blog\nstatus=published\n~~~~~~\n";
                  const content = header + mdContent;
                  fs.writeFileSync(`./content/blog/2023/${gist.id}.md`, content);
                  newArticles++;
                }
              });
            });
      - name: Commit and Push
        if: steps.fetch-gists.outputs.newArticles > 0
        run: |
          git config --local user.email "gantoin@pm.me"
          git config --local user.name "gantoin"
          git add .
          git commit -m "ðŸ¤– [Automated] Fetch Gists"
          git push
